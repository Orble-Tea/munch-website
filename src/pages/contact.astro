---
import Layout from "~/layouts/PageLayout.astro";
import Image from "~/components/common/Image.astro";
import dots from "~/assets/images/bg-design/contact-header-bg.png";
import contactTitle from "~/assets/images/contact-title.png";
import DOMPurify from "dompurify";
import { JSDOM } from "jsdom";
import "~/styles/contact.css";

const metadata = {
  title: "Contact",
};

// Create a DOMPurify instance for server-side sanitization
const window = new JSDOM("").window;
const purify = DOMPurify(window);

const errors = {
  firstName: "",
  lastName: "",
  email: "",
  subject: "",
  message: "",
};
let log =
  "Fill out the contact form below for inquiries, partnership opportunities, and/or customer support!";

if (Astro.request.method === "POST") {
  try {
    const data = await Astro.request.formData();
    // Sanitize all inputs, ensuring we're working with strings
    const firstName = purify.sanitize(String(data.get("FirstName") || ""));
    const lastName = purify.sanitize(String(data.get("LastName") || ""));
    const phoneNumber = purify.sanitize(String(data.get("PhoneNumber") || ""));
    const email = purify.sanitize(String(data.get("Email") || ""));
    const subject = purify.sanitize(String(data.get("Subject") || ""));
    const message = purify.sanitize(String(data.get("Message") || ""));

    // Validate form data
    if (firstName.length < 1) {
      errors.firstName = "Please enter your first name.";
    }
    if (lastName.length < 1) {
      errors.lastName = "Please enter your last name.";
    }
    if (!email.includes("@") || !email.includes(".")) {
      errors.email = "Please enter a valid email address.";
    }
    if (!subject) {
      errors.subject = "Please select a subject.";
    }
    if (message.length < 1) {
      errors.message = "Please enter your message.";
    }

    const hasErrors = Object.values(errors).some((msg) => msg);

    if (!hasErrors) {
      const content = `First Name: ${firstName}\nLast Name: ${lastName}\nPhone Number: ${phoneNumber}\nEmail: ${email}\n\nSubject: ${subject}\n\nMessage: ${message}`;

      const emailData = {
        to: "info@orble-tea.com",
        subject: "Customer Inquiry Form Submission: " + subject,
        text: content,
        "h:Reply-To": email,
      };

      const response = await fetch(`${Astro.url.origin}/api/send-email`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(emailData),
      });

      if (!response.ok) {
        throw new Error("An error occurred while sending the email.");
      }

      log = "Form submitted successfully!";
    }
  } catch (error) {
    console.error(error);
    log =
      "Error: " +
      (error instanceof Error ? error.message : "An unknown error occurred");
  }
}
---

<Layout metadata={metadata}>
  <div
    id="header"
    class="flex h-[200px] w-full flex-shrink-0 flex-col items-center bg-[#214260] sm:h-[250px] lg:h-[310px]"
  >
    <Image
      src={dots}
      alt="dots"
      style={`max-width: 100%; height: 100%; object-fit: cover;`}
    />
    <Image
      src={contactTitle}
      alt="Get In Touch"
      class="absolute mt-[60px] h-auto w-[80%] max-w-[692px] sm:mt-[100px] lg:mt-[136px]"
    />
  </div>

  <div
    id="form-container"
    class="bg-contact-form border-t-4 border-t-[#acc6dd] bg-gradient-to-b from-[#214260] to-white pb-16 font-serif sm:pb-24 lg:border-none lg:pb-32"
  >
    <div class="flex justify-center px-4">
      <h1
        class="contact-subtitle mt-8 w-full max-w-[815px] text-center font-serif text-white sm:mt-12 sm:text-left lg:mt-[71px] lg:text-[#1A2634]"
      >
        {log}
      </h1>
    </div>

    <div id="form" class="mt-8 flex justify-center px-4 sm:mt-12 lg:mt-[71px]">
      <div
        class="contact-form w-full max-w-[700px] rounded-md bg-white p-6 sm:w-[85%] sm:p-8 lg:w-[48%] lg:p-10"
      >
        <form method="POST">
          <!-- Honeypot field - hidden from users but visible to bots -->
          <div class="website-field">
            <label for="website">Website</label>
            <input
              type="text"
              name="website"
              id="website"
              tabindex="-1"
              autocomplete="off"
            />
          </div>

          <div id="textinputs">
            <div
              class="mb-6 flex flex-col gap-6 sm:mb-[45px] sm:flex-row sm:gap-0"
            >
              <div class="w-full sm:mr-4 sm:w-1/2 lg:mr-[39px]">
                <label for="FirstName" class="contact-label"> First Name</label>
                <input
                  type="text"
                  name="FirstName"
                  required
                  class="contact-input w-full border-b-2 border-gray-300"
                />
                {
                  errors.firstName && (
                    <p class="mt-1 text-sm text-red-500">{errors.firstName}</p>
                  )
                }
              </div>
              <div class="w-full sm:w-1/2">
                <label for="LastName" class="contact-label"> Last Name</label>
                <input
                  type="text"
                  name="LastName"
                  required
                  class="contact-input w-full border-b-2 border-gray-300"
                />
                {
                  errors.lastName && (
                    <p class="mt-1 text-sm text-red-500">{errors.lastName}</p>
                  )
                }
              </div>
            </div>
            <div
              class="mb-6 flex flex-col gap-6 sm:mb-[45px] sm:flex-row sm:gap-0"
            >
              <div class="w-full sm:mr-4 sm:w-1/2 lg:mr-[39px]">
                <label for="Email" class="contact-label"> Email</label>
                <input
                  type="email"
                  name="Email"
                  required
                  class="contact-input w-full border-b-2 border-gray-300"
                />
                {
                  errors.email && (
                    <p class="mt-1 text-sm text-red-500">{errors.email}</p>
                  )
                }
              </div>
              <div class="w-full sm:w-1/2">
                <label for="PhoneNumber" class="contact-label">
                  Phone Number
                </label>
                <input
                  type="tel"
                  name="PhoneNumber"
                  class="contact-input w-full border-b-2 border-gray-300"
                />
              </div>
            </div>
          </div>

          <div id="subject-select" class="mb-6 mt-4 sm:mb-[45px]">
            <label for="subject" class="contact-label"> Select Subject</label>

            <div
              id="radio-buttons"
              class="mt-4 flex flex-col gap-3 sm:flex-row sm:flex-wrap sm:justify-between sm:gap-2"
            >
              {
                [
                  "General Inquiry",
                  "Partnerships",
                  "Customer Support",
                  "Other",
                ].map((subject) => (
                  <div class="flex items-center">
                    <input
                      type="radio"
                      id={subject.toLowerCase().replace(/\s/g, "-")}
                      name="Subject"
                      value={subject.toLowerCase().replace(/\s/g, "-")}
                      class="mr-[10px]"
                      required
                    />
                    <label
                      for={subject.toLowerCase().replace(/\s/g, "-")}
                      class="text-sm sm:mr-[17px]"
                    >
                      {subject}
                    </label>
                  </div>
                ))
              }
            </div>
            {
              errors.subject && (
                <p class="mt-1 text-sm text-red-500">{errors.subject}</p>
              )
            }
          </div>

          <div class="my-6 flex flex-col sm:my-[45px]">
            <label for="message" class="contact-label"> Message</label>
            <input
              type="text"
              name="Message"
              id="message"
              required
              placeholder="Write your message..."
              class="contact-input mt-3 w-full border-b-2 border-gray-300 pb-[10px] placeholder-[#BDBDBD]"
              maxlength="500"
            />
            {
              errors.message && (
                <p class="mt-1 text-sm text-red-500">{errors.message}</p>
              )
            }
          </div>

          <div class="mb-2 flex justify-end">
            <button
              type="submit"
              class="munch-btn w-full bg-[#214260] font-serif sm:w-auto"
            >
              SEND MESSAGE
            </button>
          </div>
        </form>
      </div>
    </div>
    <script src="~/utils/contactForm.ts"></script>
  </div>
</Layout>
